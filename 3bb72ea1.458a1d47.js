(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{129:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return l}));var r=n(3),o=n(7),a=(n(0),n(286)),i=(n(287),{id:"index-redisjson",title:"Managing Document Data with RedisJSON",sidebar_label:"RedisJSON",slug:"/develop/node/nodecrashcourse/redisjson",authors:["simon"]}),s={unversionedId:"develop/node/node-crash-course/redisjson/index-redisjson",id:"develop/node/node-crash-course/redisjson/index-redisjson",isDocsHomePage:!1,title:"Managing Document Data with RedisJSON",description:"We used Redis' built-in Hash data type to represent our user and location entities.  Hashes are great for this, but they are limited in that they can only contain flat name/value pairs.  For our locations, we want to store extra details in a more structured way.",source:"@site/docs/develop/node/node-crash-course/redisjson/index-redisjson.mdx",slug:"/develop/node/nodecrashcourse/redisjson",permalink:"/develop/node/nodecrashcourse/redisjson",editUrl:"https://github.com/redis-developer/redis-developer/edit/master/docs/develop/node/node-crash-course/redisjson/index-redisjson.mdx",version:"current",sidebar_label:"RedisJSON",sidebar:"docs",previous:{title:"Introduction to Redis Modules",permalink:"/develop/node/nodecrashcourse/introductiontomodules"},next:{title:"Indexing and Querying with RediSearch",permalink:"/develop/node/nodecrashcourse/redisearch"}},c=[{value:"Coding Exercise",id:"coding-exercise",children:[]},{value:"External Resources",id:"external-resources",children:[]}],d={toc:c};function l(e){var t=e.components,i=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},d,i,{components:t,mdxType:"MDXLayout"}),Object(a.b)("div",{class:"text--center"},Object(a.b)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/NAGMJ6kEVEQ",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})),Object(a.b)("p",null,"We used Redis' built-in Hash data type to represent our user and location entities.  Hashes are great for this, but they are limited in that they can only contain flat name/value pairs.  For our locations, we want to store extra details in a more structured way."),Object(a.b)("p",null,"Here's an example of the additional data we want to store about a location:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-json"}),'{\n  "id": 121,\n  "hours": [\n    { "day": "Monday", "hours": "6-7" },\n    { "day": "Tuesday", "hours": "6-7" },\n    { "day": "Wednesday", "hours": "7-8" },\n    { "day": "Thursday", "hours": "6-9" },\n    { "day": "Friday", "hours": "8-5" },\n    { "day": "Saturday", "hours": "9-6" },\n    { "day": "Sunday", "hours": "6-4" }\n  ],\n  "socials": [\n    {\n      "instagram": "theginclub",\n      "facebook": "theginclub",\n      "twitter": "theginclub"\n    }\n  ],\n  "website": "www.theginclub.com",\n  "description": "Lorem ipsum...",\n  "phone": "(318) 251-0608"\n}\n')),Object(a.b)("p",null,"We could store this data as serialized JSON in a Redis String, but then our application would have to retrieve and parse the entire document every time it wanted to read some of the data.  And we'd have to do the same to update it too.  Furthermore, with this approach, update operations aren't atomic and a second client could update the JSON stored at a given key while we're making changes to it in our application code.  Then, when we serialize our version of the JSON back into the Redis String, the other client's changes would be lost."),Object(a.b)("p",null,"RedisJSON adds a new JSON data type to Redis, and a query syntax for selecting and updating individual elements in a JSON document atomically on the Redis server.  This makes our application code simpler, more efficient, and much more reliable."),Object(a.b)("h2",{id:"coding-exercise"},"Coding Exercise"),Object(a.b)("p",null,"In this exercise, you'll complete the code for an API route that gets just the object representing a location's opening hours for a given day.  Open the file ",Object(a.b)("inlineCode",{parentName:"p"},"src/routes/location_routes.js"),", and find the route for ",Object(a.b)("inlineCode",{parentName:"p"},"/location/:locationId/hours/:day"),".  The starter code looks like this:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-javascript"}),"// EXERCISE: Get opening hours for a given day.\nrouter.get(\n  '/location/:locationId/hours/:day',\n  [\n    param('locationId').isInt({ min: 1 }),\n    param('day').isInt({ min: 0, max: 6 }),\n    apiErrorReporter,\n  ],\n  async (req, res) => {\n    /* eslint-disable no-unused-vars */\n    const { locationId, day } = req.params;\n    /* eslint-enable */\n    const locationDetailsKey = redis.getKeyName('locationdetails', locationId);\n\n    // TODO: Get the opening hours for a given day from\n    // the JSON stored at the key held in locationDetailsKey.\n    // You will need to provide the correct JSON path to the hours\n    // array and return the element held in the position specified by\n    // the day variable.  Make sure RedisJSON returns only the day\n    // requested!\n    const jsonPath = 'TODO';\n\n    /* eslint-enable no-unused-vars */\n    const hoursForDay = JSON.parse(await redisClient.call('JSON.GET', locationDetailsKey, jsonPath));\n    /* eslint-disable */\n\n    // If null response, return empty object.\n    res.status(200).json(hoursForDay || {});\n  },\n);\n")),Object(a.b)("p",null,'You\'ll need to update the code to provide the correct JSON path, replacing the "TODO" value with a JSON path expression.'),Object(a.b)("p",null,"Looking at the JSON stored at key ",Object(a.b)("inlineCode",{parentName:"p"},"ncc:locationdetails:121"),", we see that the opening hours are stored as an array of objects in a field named ",Object(a.b)("inlineCode",{parentName:"p"},"hours"),", where day 0 is Monday and day 6 is Sunday:"),Object(a.b)("p",null,Object(a.b)("img",{alt:"Location Details in RedisInsight",src:n(565).default})),Object(a.b)("p",null,"So you'll need a JSON path query that gets the right element from the ",Object(a.b)("inlineCode",{parentName:"p"},"hours")," array depending on the value stored in the variable ",Object(a.b)("inlineCode",{parentName:"p"},"day"),"."),Object(a.b)("p",null,"If you're using redis-cli, you can look at the structure of the JSON document with the following command:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),"json.get ncc:locationdetails:121 .\n")),Object(a.b)("p",null,"Make sure your query returns only the day requested, so that you don't have to write Node.js code to filter the value returned from Redis.  Use the ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://oss.redis.com/redisjson/path/"}),"RedisJSON path syntax page")," to help you formulate the right query."),Object(a.b)("p",null,"To test your code, start the server with:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-bash"}),"$ npm run dev\n")),Object(a.b)("p",null,"Recall that this will allow you to edit the code and try your changes without restarting the server."),Object(a.b)("p",null,"If you have the correct JSON path in your code, visiting ",Object(a.b)("inlineCode",{parentName:"p"},"http://localhost:80801/api/location/121/hours/2")," should return:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-json"}),'{\n  "day": "Wednesday",\n  "hours": "7-8"\n}\n')),Object(a.b)("p",null,"Don't forget that if you have questions or need help, we're available on ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://discord.gg/redis"}),"Discord"),"."),Object(a.b)("h2",{id:"external-resources"},"External Resources"),Object(a.b)("p",null,"In this video, Justin introduces RedisJSON using a fun taco truck example!"),Object(a.b)("div",{class:"text--center"},Object(a.b)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/2mFakgHKme4",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})),Object(a.b)("p",null,"Learn more about RedisJSON at its ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://redisjson.io/"}),"official homepage"),"."))}l.isMDXComponent=!0},286:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var r=n(0),o=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var d=o.a.createContext({}),l=function(e){var t=o.a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=l(e.components);return o.a.createElement(d.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},h=o.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,i=e.parentName,d=c(e,["components","mdxType","originalType","parentName"]),u=l(n),h=r,b=u["".concat(i,".").concat(h)]||u[h]||p[h]||a;return n?o.a.createElement(b,s(s({ref:t},d),{},{components:n})):o.a.createElement(b,s({ref:t},d))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=h;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var d=2;d<a;d++)i[d]=n[d];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},287:function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return i}));var r=n(21),o=n(295);function a(){var e=Object(r.default)().siteConfig,t=(e=void 0===e?{}:e).baseUrl,n=void 0===t?"/":t,a=e.url;return{withBaseUrl:function(e,t){return function(e,t,n,r){var a=void 0===r?{}:r,i=a.forcePrependBaseUrl,s=void 0!==i&&i,c=a.absolute,d=void 0!==c&&c;if(!n)return n;if(n.startsWith("#"))return n;if(Object(o.b)(n))return n;if(s)return t+n;var l=n.startsWith(t)?n:t+n.replace(/^\//,"");return d?e+l:l}(a,n,e,t)}}}function i(e,t){return void 0===t&&(t={}),(0,a().withBaseUrl)(e,t)}},295:function(e,t,n){"use strict";function r(e){return!0===/^(\w*:|\/\/)/.test(e)}function o(e){return void 0!==e&&!r(e)}n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return o}))},565:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/locationdetails_redis_json-41f31f97850de2e1f8623a79e4f2c1b2.png"}}]);